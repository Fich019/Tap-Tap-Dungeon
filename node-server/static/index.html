<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>WebSocket Staging Server &middot; Supine Research</title>

    <link rel="stylesheet" href="https://supine.dev/style.css">
    <script src="https://kit.fontawesome.com/a51a07443c.js" crossorigin="anonymous"></script>
    <link rel="icon" href="https://media.supine.dev/logos/supine-white.png">
    <meta property="og:image" content="https://media.supine.dev/logos/supine-white.png" />
    <meta property="twitter:image" content="https://media.supine.dev/logos/supine-white.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="msapplication-TileColor" content="ffffff">
    <meta name="theme-color" content="#ffffff">
    <style>
        .container {
            position: absolute;
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            top: 50px;
        }

        .code-explain {
            font-size: 3em;
        }

        input {font-family: 'Unica One', sans-serif;text-align: center;font-size: 2em;width: 6em;border-radius: 4px;border: 1px solid #ccc;}
        button.btn {
            border: 1px solid rgba(0,0,0,0.2);
            border-radius: 4px;
            font-size: 1em;
            padding: 4px 10px;
            cursor: pointer;
            user-select: none;
        }

        input#code {
            margin-bottom: .25em;
            margin-top: .1em;
        }

        .btn-success {
            background-color: #4CAF50;
            color: white;
        }
        .btn[disabled] {
            background-color: #e0e0e0;
            color: #999;
            cursor: not-allowed;
        }
        .hide {
            display: none !important;
        }
        #code-name {
            font-weight: bold;
            font-size: 4em;
            margin-bottom: .2em;
        }
        #play .btn {
            margin: 4px;
            font-size: 1.5em;
        }
    </style>
    <style>
        #map {
            width: 500px;
            height: 500px;
            background-color: lightblue;
            border: 1px solid gray;
            margin: 20px 0;
            position: relative;
        }
        .blob {
            position: absolute;
            opacity: 1;
            transform-origin: 100% 100%;
            transition: all 40ms linear, opacity 2s linear;
        }
        .blob--player .blob-content { background: dodgerblue; }
        .blob--enemy .blob-content { background: darkred; }
        .blob-content {
            --size: 36px;
            width: var(--size);
            height: var(--size);
            background: gray;
            border-radius: 50%;
            position: relative;
            /*bottom: calc(var(--size) / 2);
            left: calc(var(--size) / -2);*/
        }


        .blob--player .blob-content {
            background-image: url("/media/sprites/Player 1/P-Arrow.png");
            border-radius: 0;
            background-position: center;
            background-size: 100%;
            background-repeat: no-repeat;
            background-color: transparent;
        }



        .blob.kill {
            opacity: 0;
        }

        #map {
            --offset: -135deg;
            transform: rotate(var(--offset));
            margin-top: 200px;
            overflow: hidden;
        }

        #map {
            border: 4px solid #3a3a3a;
            --accept: #d1d1d1;
        }
        #map[data-room-n="true"] {
            border-bottom-color: var(--accept);
        }
        #map[data-room-e="true"] {
            border-left-color: var(--accept);
        }
        #map[data-room-w="true"] {
            border-right-color: var(--accept);
        }
        #map[data-room-s="true"] {
            border-top-color: var(--accept);
        }
    </style>
</head>
<body>

<div class="container" id="login">
    <div class="code-explain">Enter your room code</div>
    <input type="text" id="code" placeholder="Room code" maxlength="4">
    <button class="btn btn-success" id="submit-room" disabled>Go!</button>
</div>
<div class="container hide" id="play">
    <div id="code-name"></div>


    <div id="map">
        <!--<div id="player"  class="blob blob--player"><div class="blob-content"></div></div>
        <div id="enemy-1" class="blob blob--enemy"><div class="blob-content"></div></div>-->
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
<script>
    const socket = io("wss://research.supine.dev:3018");

    socket.on('connection', function() {
        console.log('Connectioned to research server!');
    });
    socket.on('connected', function() {
        console.log('Connected to research server!');
    });
    socket.on('game:action', function(action) {
        console.log('Game action from client', action);
    });
    socket.on('rooms:joined', function(code) {
        console.log(`Successfully joined room ${code}`);
        document.querySelector('#code-name').innerHTML = code;
        document.querySelector('#play').classList.remove('hide');
        document.querySelector('#login').classList.add('hide');
    });
    socket.on('message', console.log);

    socket.on('player:position', function(/* array [x,z] */ pos) {
        console.warn("player:position is deprecated.");
        //console.log(`Changing player position to`, pos);

        [x,z] = checkPos(pos);

        document.querySelector('#player').style.left = `${x * 100}%`
        document.querySelector('#player').style.bottom = `${z * 100}%`

    });

    const els = {
        "player": document.querySelector('#player')
    };


    let offsets = {};

    socket.on('object:position', function(blob) {
        //console.log('object:position', blob);
        let el = els[blob.identifier];
        if (!el) return;

        [x,z] = checkPos(blob.position);

        /*document.querySelector(`#${blob.identifier}`)
        document.querySelector(`#${blob.identifier}`)*/

        el.style.left = `${x * 100}%`;
        el.style.bottom = `${z * 100}%`;

        if (blob.rotation) {
            if (!offsets[blob.identifier]) offsets[blob.identifier] = 360;

            // Check to see if we're going past 360/0 etc
            const finder = /(.[^\s]*)\((.*?)\)/g;
            let transforms = [...(el.style.transform).matchAll(finder)];
            let rotation = transforms.find(t => t[1].trim() === "rotate");
            if (rotation) {
                console.log(Math.floor(Math.abs((parseFloat(rotation[2].replace('deg','')) / 360))), (Math.floor(Math.abs(((blob.rotation - offsets[blob.identifier]) / 360)))));
                console.log(Math.floor(parseFloat(rotation[2]) / 360) ,((Math.floor(blob.rotation) - offsets[blob.identifier]) / 360))

                if (Math.floor(parseFloat(rotation[2]) / 360) !== ((Math.floor(blob.rotation) - offsets[blob.identifier]) / 360)) {
//                    console.log(`flip`);
                }
            }

            el.style.transform = `rotate(${ blob.rotation - offsets[blob.identifier] }deg) translate(50%, 50%)`;
        }

    });

    (function() {
        let el = document.querySelector('#map');
        el.addEventListener('click', function(evt) {
            console.log(evt.srcElement);
            let rect = evt.srcElement.getBoundingClientRect();

            let [x,z] = [
                evt.offsetX / rect.height,
                (rect.width - evt.offsetY) / rect.width];

            console.log(x, z);

            socket.emit('game:action', 'bomb', x, z);
        });
    })();


    let remoteMap = [-15, 15];
    let remoteCenter = [0, 0];
    function updatePositioning(roomPosition) {
        remoteCenter = roomPosition;
    }
    function checkPos(pos) {

        //console.log(`Changing player position to`, pos);


        pos = pos.map((p,i) => p += ((0 - remoteMap[0]) - remoteCenter[i]));
        //console.log(pos, `(/${(0 - remoteMap[0]) + remoteMap[1]})`);
        pos = pos.map(p => p / ((0 - remoteMap[0]) + remoteMap[1]));
        //console.log(pos);

        return pos;
    }

    document.querySelector('#code').addEventListener('input', function() {
        let _el = document.querySelector('#code');
        if (_el.value.toString().length === 4) {
            document.querySelector('#submit-room').removeAttribute('disabled');
        } else {
            document.querySelector('#submit-room').setAttribute('disabled', 'true');
        }
    });
    document.querySelector('#code').addEventListener('keydown', function(e) {
        if (e.keyCode === 13) {
            submitRoom();
        }
    });
    function submitRoom() {
        let code = document.querySelector('#code').value;


        console.log(`Joining room ${code}`);
        socket.emit('rooms:join', code);
    }
    document.querySelector('#submit-room').addEventListener('click', submitRoom)

    Array.from(document.querySelectorAll('.action-button')).forEach(el => {
        el.addEventListener('click', function() {
            socket.emit('game:action', el.dataset.action);
        })
    });

    function createEntity(identifier, className) {
        document.querySelector('#map').insertAdjacentHTML('beforeend', `<div class="blob blob--${className}" id="${identifier}"><div class="blob-content"></div></div>`);
        return document.querySelector('#map').lastChild;
    }

    socket.on('entity:create', blob => {
        console.log("create", blob);
        if (!els[blob.identifier]) {
            els[blob.identifier] = createEntity(blob.identifier, blob.className);
        }
    })
    socket.on('entity:destroy', blob => {
        console.log("destroy", blob);
        els[blob.identifier].classList.add('kill');
        setTimeout(function() {
            els[blob.identifier].remove();
        }, 2000);
    })
    socket.on('room:update', blob => console.log("room", blob));

    function getColorStr(color) {
        return `rgb(${color.map(c => `${c * 100}%`).join(',')})`;
    }
    socket.on('room:update', room => {
        let rgb = getColorStr(room.color);
        document.querySelector('#map').style.backgroundColor = rgb;
        updatePositioning(room.position);

        const doorLetters = ["N", "E", "W", "S"];
        room.doors.forEach((bool,i) => {
            document.querySelector('#map').dataset[`room${doorLetters[i]}`] = bool;
            // outputs as [data-room-N="true"] etc
        })
    })
</script>
</body>
</html>